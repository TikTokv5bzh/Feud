<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl; /* Set text direction to right-to-left for Arabic */
        }
        /* Custom scrollbar for player list */
        .player-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .player-list-container::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
            border-radius: 10px;
        }
        .player-list-container::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-700 */
            border-radius: 10px;
        }
        .player-list-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* bg-gray-400 */
        }
        textarea {
            resize: vertical; /* Allow vertical resizing for textarea */
        }
        /* Style for disabled/excluded players */
        .excluded-player {
            opacity: 0.5;
            text-decoration: line-through;
            pointer-events: none; /* Disable click events on excluded players */
        }
        /* Hide exclusion buttons by default */
        .exclusion-buttons {
            display: none;
        }
        /* Show exclusion buttons when parent is active (clicked) */
        .player-game-item.active .exclusion-buttons {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
    <div class="bg-gray-800 p-6 sm:p-8 md:p-10 rounded-xl shadow-lg w-full max-w-md flex flex-col space-y-6">
        <h1 class="text-3xl font-bold text-center text-red-400 mb-6">Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§</h1>

        <!-- Setup Section -->
        <div id="setup-section" class="space-y-6">
            <!-- Player Names Input (Textarea) -->
            <div class="flex flex-col gap-3">
                <label for="playerNamesInput" class="text-lg text-red-200">Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±):</label>
                <textarea id="playerNamesInput" rows="6" placeholder="Ù…Ø«Ø§Ù„:&#10;Ø£Ø­Ù…Ø¯&#10;ÙØ§Ø·Ù…Ø©&#10;Ù…Ø­Ù…Ø¯&#10;Ù„ÙŠÙ„Ù‰"
                    class="bg-gray-700 text-white placeholder-gray-400 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200"></textarea>
                <button id="setPlayersButton"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
                </button>
            </div>

            <!-- Player List Display in Table -->
            <div>
                <h2 class="text-xl font-semibold mb-3 text-red-300">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="playerCount">0</span>):</h2>
                <div class="player-list-container bg-gray-700 p-4 rounded-lg max-h-48 overflow-y-auto">
                    <table class="w-full text-white table-auto">
                        <thead>
                            <tr class="text-gray-400 border-b border-gray-600">
                                <th class="py-2 text-right">Ø§Ù„Ø§Ø³Ù…</th>
                                <th class="py-2 text-left w-20"></th> <!-- For delete button -->
                            </tr>
                        </thead>
                        <tbody id="playerListTableBody">
                            <!-- Player rows will be appended here -->
                        </tbody>
                    </table>
                    <p class="text-gray-400 text-center py-4" id="noPlayersMessage">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù…Ø¶Ø§ÙÙˆÙ† Ø¨Ø¹Ø¯.</p>
                </div>
            </div>

            <!-- Role Configuration -->
            <div class="grid grid-cols-2 gap-4 text-red-200">
                <div class="flex flex-col">
                    <label for="mafiaCount" class="mb-1 text-lg">Ø§Ù„Ù…Ø§ÙÙŠØ§:</label>
                    <input type="number" id="mafiaCount" min="0" value="1"
                        class="bg-gray-700 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200">
                </div>
                <div class="flex flex-col">
                    <label for="elderCount" class="mb-1 text-lg">Ø§Ù„Ø´Ø§ÙŠØ¨:</label>
                    <input type="number" id="elderCount" min="0" value="0"
                        class="bg-gray-700 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200">
                </div>
                <div class="flex flex-col">
                    <label for="doctorCount" class="mb-1 text-lg">Ø§Ù„Ø¯ÙƒØªÙˆØ±:</label>
                    <input type="number" id="doctorCount" min="0" value="0"
                        class="bg-gray-700 text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200">
                </div>
                <div class="flex flex-col">
                    <label for="citizenCount" class="mb-1 text-lg">Ø§Ù„Ù…ÙˆØ§Ø·Ù†:</label>
                    <input type="number" id="citizenCount" min="0" value="0" readonly
                        class="bg-gray-700 text-gray-400 p-2 rounded-lg cursor-not-allowed">
                </div>
            </div>

            <!-- Start Game Button -->
            <button id="startGameButton"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
            </button>
        </div>

        <!-- Organizer Roles Overview Section (New Section) -->
        <div id="organizer-roles-overview-section" class="hidden flex flex-col items-center justify-center space-y-6 min-h-[250px]">
            <h2 class="text-2xl sm:text-3xl font-bold text-red-300">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Ù„Ù„Ù…Ù†Ø¸Ù…)</h2>
            <p class="text-md text-gray-400 text-center">ÙŠÙ…ÙƒÙ†Ùƒ Ø®Ù„Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø¯Ø© Ù…Ø±Ø§Øª. Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
            <div id="rolesOverviewList" class="w-full bg-gray-700 p-4 rounded-lg max-h-60 overflow-y-auto space-y-2">
                <!-- Roles will be displayed here dynamically -->
            </div>
            <button id="shuffleRolesDisplayButton"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full">
                Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
            </button>
            <button id="proceedToGameplayButton"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full">
                Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨
            </button>
        </div>

        <!-- Gameplay Section (Initially Hidden) -->
        <div id="gameplay-section" class="hidden flex flex-col items-center justify-center space-y-6 min-h-[250px]">
            <h2 class="text-xl sm:text-2xl font-bold text-red-300">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†:</h2>
            <!-- Changed grid-cols-1 to grid-cols-2 to always show two names per row -->
            <div id="activePlayersGrid" class="w-full grid grid-cols-2 gap-4 max-h-80 overflow-y-auto p-2">
                <!-- Active player boxes will be appended here -->
            </div>
            <p id="gameStatusMessage" class="text-lg text-red-200 mt-4"></p>
        </div>

        <!-- Game Over Section (Initially Hidden) -->
        <div id="game-over-section" class="hidden flex flex-col items-center justify-center space-y-6">
            <p id="finalGameResultMessage" class="text-3xl font-bold text-center text-red-500"></p>
            <h2 class="text-xl font-semibold text-red-300">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</h2>
            <div id="finalPlayersRoles" class="w-full bg-gray-700 p-4 rounded-lg max-h-60 overflow-y-auto text-center">
                <!-- Final player roles will be displayed here -->
            </div>
            <button id="resetGameButton"
                class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mt-6">
                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            </button>
        </div>


        <!-- Custom Message Box -->
        <div id="messageBox"
            class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 p-6 rounded-xl shadow-lg flex flex-col items-center space-y-4">
                <p id="messageText" class="text-white text-lg text-center"></p>
                <button id="closeMessageBox"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg transition duration-200">
                    Ù…ÙˆØ§ÙÙ‚
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const playerNamesInput = document.getElementById('playerNamesInput');
        const setPlayersButton = document.getElementById('setPlayersButton');
        const playerListTableBody = document.getElementById('playerListTableBody'); // For setup phase
        const playerCountSpan = document.getElementById('playerCount');
        const noPlayersMessage = document.getElementById('noPlayersMessage');

        const mafiaCountInput = document.getElementById('mafiaCount');
        const elderCountInput = document.getElementById('elderCount');
        const doctorCountInput = document.getElementById('doctorCount');
        const citizenCountInput = document.getElementById('citizenCount');

        const startGameButton = document.getElementById('startGameButton');
        const resetGameButton = document.getElementById('resetGameButton');

        const setupSection = document.getElementById('setup-section');
        // Removed roleRevealSection as it's no longer used
        // const roleRevealSection = document.getElementById('role-reveal-section');
        // const currentPlayerNameDisplay = document.getElementById('currentPlayerName');
        // const showRoleButton = document.getElementById('showRoleButton');
        // const currentPlayerRoleDisplay = document.getElementById('currentPlayerRole');
        // const nextPlayerButton = document.getElementById('nextPlayerButton');

        // New elements for Organizer Roles Overview
        const organizerRolesOverviewSection = document.getElementById('organizer-roles-overview-section');
        const rolesOverviewList = document.getElementById('rolesOverviewList');
        const shuffleRolesDisplayButton = document.getElementById('shuffleRolesDisplayButton');
        const proceedToGameplayButton = document.getElementById('proceedToGameplayButton');


        const gameplaySection = document.getElementById('gameplay-section');
        const activePlayersGrid = document.getElementById('activePlayersGrid'); // Changed to grid for player boxes
        const gameStatusMessage = document.getElementById('gameStatusMessage');
        // Removed noActivePlayersMessage as its logic will be handled by checking activePlayersGrid.children.length

        const gameOverSection = document.getElementById('game-over-section');
        const finalGameResultMessage = document.getElementById('finalGameResultMessage');
        const finalPlayersRoles = document.getElementById('finalPlayersRoles');

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBox = document.getElementById('closeMessageBox');


        // Game State Variables
        let players = []; // Stores initial player names
        // assignedRoles stores { name: "Player", role: "Mafia", isExcluded: false } objects for the current game
        let assignedRoles = [];
        // currentPlayerIndex and isRoleRevealed are no longer needed for the new flow
        // let currentPlayerIndex = 0;
        // let isRoleRevealed = false;

        // Role mapping for display
        const roleNames = {
            'Mafia': 'Ø§Ù„Ù…Ø§ÙÙŠØ§ ğŸº',
            'Elder': 'Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ‘´',
            'Doctor': 'Ø§Ù„Ø¯ÙƒØªÙˆØ± ğŸ‘©â€âš•ï¸',
            'Citizen': 'Ø§Ù„Ù…ÙˆØ§Ø·Ù† ğŸ§‘â€ğŸ¤â€ğŸ§‘'
        };

        // --- Local Storage Management ---

        /**
         * Saves player names and role settings to local storage.
         */
        function saveGameData() {
            localStorage.setItem('mafiaPlayers', JSON.stringify(players));
            const settings = {
                mafia: parseInt(mafiaCountInput.value) || 0,
                elder: parseInt(elderCountInput.value) || 0,
                doctor: parseInt(doctorCountInput.value) || 0
            };
            localStorage.setItem('mafiaSettings', JSON.stringify(settings));
        }

        /**
         * Loads player names and role settings from local storage.
         */
        function loadGameData() {
            const savedPlayers = localStorage.getItem('mafiaPlayers');
            if (savedPlayers) {
                players = JSON.parse(savedPlayers);
                playerNamesInput.value = players.join('\n'); // Populate textarea with loaded names
            }

            const savedSettings = localStorage.getItem('mafiaSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                mafiaCountInput.value = settings.mafia;
                elderCountInput.value = settings.elder;
                doctorCountInput.value = settings.doctor;
            }
            renderPlayers(); // Render players after loading
            updateCitizenCount(); // Update citizen count based on loaded settings and players
        }

        // --- Helper Functions ---

        /**
         * Shuffles an array in place (Fisher-Yates algorithm).
         * @param {Array} array The array to shuffle.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        /**
         * Displays a custom message box instead of alert.
         * @param {string} message The message to display.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        // --- Player Management (Setup Phase) ---

        /**
         * Renders the current list of players in the UI table.
         */
        function renderPlayers() {
            playerListTableBody.innerHTML = ''; // Clear existing list
            if (players.length === 0) {
                noPlayersMessage.classList.remove('hidden');
            } else {
                noPlayersMessage.classList.add('hidden');
                players.forEach((player, index) => {
                    const row = playerListTableBody.insertRow();
                    row.className = 'border-b border-gray-700 last:border-0';
                    row.innerHTML = `
                        <td class="py-2 text-lg">${player}</td>
                        <td class="py-2 text-left">
                            <button class="remove-player-button bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded-md transition duration-200" data-index="${index}">
                                Ø­Ø°Ù
                            </button>
                        </td>
                    `;
                });
            }
            playerCountSpan.textContent = players.length;
            updateCitizenCount(); // Update citizen count whenever players change
            saveGameData(); // Save changes to local storage
        }

        /**
         * Sets players from the textarea input.
         */
        function setPlayersFromInput() {
            const inputNames = playerNamesInput.value.split('\n').map(name => name.trim()).filter(name => name !== '');
            const uniqueNames = [...new Set(inputNames)]; // Remove duplicates

            if (uniqueNames.length === 0) {
                showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.");
                return;
            }

            if (uniqueNames.length !== inputNames.length) {
                showMessageBox("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙƒØ±Ø±Ø©.");
            }

            players = uniqueNames;
            renderPlayers();
        }

        /**
         * Removes a player from the list.
         * @param {number} index The index of the player to remove.
         */
        function removePlayer(index) {
            players.splice(index, 1); // Remove player at index
            renderPlayers();
        }

        // --- Role Configuration ---

        /**
         * Calculates and updates the citizen count based on total players and other roles.
         */
        function updateCitizenCount() {
            const totalPlayers = players.length;
            const mafia = parseInt(mafiaCountInput.value) || 0;
            const elder = parseInt(elderCountInput.value) || 0;
            const doctor = parseInt(doctorCountInput.value) || 0;

            const assignedRolesCount = mafia + elder + doctor;
            let citizen = totalPlayers - assignedRolesCount;

            if (citizen < 0) {
                citizen = 0; // Prevent negative citizen count, roles will exceed players
            }
            citizenCountInput.value = citizen;
            saveGameData(); // Save settings whenever counts change
        }

        // --- Game Logic ---

        /**
         * Initializes and starts the game.
         */
        function startGame() {
            const totalPlayers = players.length;
            const mafia = parseInt(mafiaCountInput.value) || 0;
            const elder = parseInt(elderCountInput.value) || 0;
            const doctor = parseInt(doctorCountInput.value) || 0;
            const citizen = parseInt(citizenCountInput.value) || 0; // Use calculated citizen count

            const totalRoles = mafia + elder + doctor + citizen;

            if (totalPlayers < 3) { // Minimum players for Mafia game
                showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.");
                return;
            }

            if (totalRoles === 0) {
                showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.");
                return;
            }

            if (totalRoles !== totalPlayers) {
                showMessageBox(`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (${totalRoles}) Ù„Ø§ ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (${totalPlayers}). Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¶Ø¨Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø±.`);
                return;
            }

            if (mafia === 0) {
                showMessageBox("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø§ÙÙŠØ§.");
                return;
            }

            // Create roles array
            const rolesPool = [];
            for (let i = 0; i < mafia; i++) rolesPool.push('Mafia');
            for (let i = 0; i < elder; i++) rolesPool.push('Elder');
            for (let i = 0; i < doctor; i++) rolesPool.push('Doctor');
            for (let i = 0; i < citizen; i++) rolesPool.push('Citizen');

            shuffleArray(rolesPool); // Shuffle the roles

            // Assign roles to players
            const shuffledPlayers = [...players]; // Create a copy and shuffle players
            shuffleArray(shuffledPlayers);

            assignedRoles = shuffledPlayers.map((player, index) => ({
                name: player,
                role: rolesPool[index],
                isExcluded: false // Add exclusion status
            }));

            // Hide all sections initially then show the correct one
            setupSection.classList.add('hidden');
            gameplaySection.classList.add('hidden');
            gameOverSection.classList.add('hidden');
            resetGameButton.classList.add('hidden');

            // Show the new organizer roles overview section
            organizerRolesOverviewSection.classList.remove('hidden');
            displayOrganizerRolesOverview(); // Initial display of roles for organizer
        }

        /**
         * Displays the shuffled list of players and their roles for the organizer.
         */
        function displayOrganizerRolesOverview() {
            rolesOverviewList.innerHTML = '';
            const rolesToDisplay = [...assignedRoles]; // Create a copy
            shuffleArray(rolesToDisplay); // Shuffle the copy for random display

            rolesToDisplay.forEach(player => {
                const playerRoleDiv = document.createElement('div');
                playerRoleDiv.className = 'bg-gray-600 p-2 rounded-md flex justify-between items-center text-lg';
                playerRoleDiv.innerHTML = `
                    <span class="text-gray-100">${player.name}</span>
                    <span class="font-semibold text-red-300">${roleNames[player.role]}</span>
                `;
                rolesOverviewList.appendChild(playerRoleDiv);
            });
        }


        // --- Gameplay Phase ---

        /**
         * Transitions to and displays the gameplay phase.
         */
        function showGameplayPhase() {
            organizerRolesOverviewSection.classList.add('hidden'); // Hide organizer section
            gameplaySection.classList.remove('hidden'); // Show gameplay section
            renderActivePlayers();
            gameStatusMessage.textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø¥Ù‚ØµØ§Ø¦Ù‡.';
        }

        /**
         * Renders the list of active players in the UI grid for the gameplay phase.
         */
        function renderActivePlayers() {
            activePlayersGrid.innerHTML = ''; // Clear existing list
            // Sort by excluded status first, then by name
            const sortedPlayers = [...assignedRoles].sort((a, b) => {
                if (a.isExcluded === b.isExcluded) {
                    return a.name.localeCompare(b.name); // Sort alphabetically if status is same
                }
                return a.isExcluded ? 1 : -1; // Excluded players last (true for excluded, false for not)
            });

            if (sortedPlayers.length === 0) {
                checkGameEndConditions();
                return;
            }

            sortedPlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-game-item relative bg-gray-600 p-4 rounded-lg shadow-md flex flex-col items-center justify-center transition duration-200 ${player.isExcluded ? 'excluded-player' : 'cursor-pointer hover:bg-gray-500'}`;
                playerDiv.dataset.playerName = player.name; // Store name for click event

                playerDiv.innerHTML = `
                    <span class="text-xl font-semibold text-gray-100 mb-2">${player.name} ${player.isExcluded ? 'ğŸ’€' : ''}</span>
                    <div class="exclusion-buttons flex gap-2 w-full justify-center">
                        <button class="exclude-vote-button bg-yellow-600 hover:bg-yellow-700 text-white text-3xl p-2 rounded-lg shadow-md transition duration-200 flex items-center justify-center" data-player-name="${player.name}">
                            ğŸ—³ï¸
                        </button>
                        <button class="exclude-kill-button bg-red-600 hover:bg-red-700 text-white text-3xl p-2 rounded-lg shadow-md transition duration-200 flex items-center justify-center" data-player-name="${player.name}">
                            ğŸ”ª
                        </button>
                    </div>
                `;

                // Add click listener to the player box to toggle buttons
                if (!player.isExcluded) {
                    playerDiv.addEventListener('click', (e) => {
                        // If the click target is one of the buttons, prevent propagation to parent div's click
                        if (e.target.closest('button')) {
                            return;
                        }
                        
                        // Close any other open buttons first
                        document.querySelectorAll('.player-game-item.active').forEach(item => {
                            if (item !== playerDiv) {
                                item.classList.remove('active');
                            }
                        });
                        // Toggle active state for current player box
                        playerDiv.classList.toggle('active');
                    });
                }
                activePlayersGrid.appendChild(playerDiv);
            });

            // Add event listeners for the dynamically created buttons
            activePlayersGrid.querySelectorAll('.exclude-vote-button').forEach(button => {
                button.onclick = (e) => excludePlayer(e.target.dataset.playerName);
            });
            activePlayersGrid.querySelectorAll('.exclude-kill-button').forEach(button => {
                button.onclick = (e) => excludePlayer(e.target.dataset.playerName);
            });

            checkGameEndConditions(); // Check conditions after rendering active players
        }

        /**
         * Excludes a player from the game.
         * @param {string} playerName The name of the player to exclude.
         */
        function excludePlayer(playerName) {
            const playerToExclude = assignedRoles.find(p => p.name === playerName);
            if (playerToExclude) {
                playerToExclude.isExcluded = true;
                renderActivePlayers(); // Re-render to show updated active list
                showMessageBox(`${playerName} ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ù‡.`);
            }
            // After exclusion, ensure all exclusion buttons are hidden (if any were open)
            document.querySelectorAll('.player-game-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        /**
         * Checks if the game has ended based on win/loss conditions.
         */
        function checkGameEndConditions() {
            const activeMafia = assignedRoles.filter(p => !p.isExcluded && p.role === 'Mafia').length;
            const activeTown = assignedRoles.filter(p => !p.isExcluded && (p.role === 'Citizen' || p.role === 'Doctor' || p.role === 'Elder')).length;

            let gameEnded = false;
            let resultMessage = '';

            if (activeMafia === 0 && assignedRoles.length > 0) { // All mafia excluded
                resultMessage = 'ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†! ØªÙ… Ø§Ù„Ù‚Ø¶Ø§Ø¡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§.';
                gameEnded = true;
            } else if (activeMafia > 0 && activeMafia >= activeTown) { // Mafia outnumbers or equals town
                resultMessage = 'ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§! Ø¹Ø¯Ø¯ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§ ÙŠØ³Ø§ÙˆÙŠ Ø£Ùˆ ÙŠØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†.';
                gameEnded = true;
            } else if (assignedRoles.length > 0 && activeMafia === 0 && activeTown === 0) { // All players excluded
                 resultMessage = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ù„Ù… ÙŠØªØ¨Ù‚ Ø£ÙŠ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†.';
                 gameEnded = true;
            }


            if (gameEnded) {
                endGame(resultMessage);
            }
        }

        /**
         * Ends the game and displays the results.
         * @param {string} message The final message for the game result.
         */
        function endGame(message) {
            gameplaySection.classList.add('hidden');
            organizerRolesOverviewSection.classList.add('hidden'); // Ensure organizer section is hidden
            setupSection.classList.add('hidden'); // Ensure setup is hidden
            gameOverSection.classList.remove('hidden');
            finalGameResultMessage.textContent = message;
            resetGameButton.classList.remove('hidden');

            // Display final roles
            finalPlayersRoles.innerHTML = '';
            assignedRoles.forEach(player => {
                const playerDiv = document.createElement('div');
                let status = player.isExcluded ? 'ğŸ’€ (Ù…Ù‚ØµÙ‰)' : 'âœ… (Ù†Ø´Ø·)';
                playerDiv.className = `p-2 rounded-md shadow-sm ${player.isExcluded ? 'bg-gray-600 text-gray-400' : 'bg-gray-500 text-white'}`;
                playerDiv.innerHTML = `<span class="font-semibold">${player.name}</span>: ${roleNames[player.role] || player.role} ${status}`;
                finalPlayersRoles.appendChild(playerDiv);
            });
        }


        /**
         * Resets the entire game to its initial state.
         */
        function resetGame() {
            players = [];
            assignedRoles = [];
            // currentPlayerIndex and isRoleRevealed are no longer needed
            // currentPlayerIndex = 0;
            // isRoleRevealed = false;

            playerNamesInput.value = '';
            mafiaCountInput.value = 1;
            elderCountInput.value = 0;
            doctorCountInput.value = 0;
            // citizenCountInput will be updated by renderPlayers

            renderPlayers(); // Clear player list display and update citizen count
            saveGameData(); // Save empty/default state

            setupSection.classList.remove('hidden');
            organizerRolesOverviewSection.classList.add('hidden'); // Hide organizer section
            gameplaySection.classList.add('hidden');
            gameOverSection.classList.add('hidden');
            resetGameButton.classList.add('hidden');

            // Removed elements specific to the old role reveal section
            // currentPlayerNameDisplay.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨';
            // currentPlayerRoleDisplay.classList.add('hidden');
            // showRoleButton.classList.remove('hidden');
            // nextPlayerButton.classList.add('hidden');

            gameStatusMessage.textContent = '';
            activePlayersGrid.innerHTML = '';
            finalGameResultMessage.textContent = '';
            finalPlayersRoles.innerHTML = '';
        }

        // --- Event Listeners ---

        // Set players from textarea
        setPlayersButton.addEventListener('click', setPlayersFromInput);

        // Event delegation for removing players
        playerListTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-player-button')) {
                const index = parseInt(e.target.dataset.index);
                removePlayer(index);
            }
        });

        // Update citizen count whenever role counts change
        mafiaCountInput.addEventListener('input', updateCitizenCount);
        elderCountInput.addEventListener('input', updateCitizenCount);
        doctorCountInput.addEventListener('input', updateCitizenCount);

        // Start game button
        startGameButton.addEventListener('click', startGame);

        // Event listeners for the new organizer roles overview section
        shuffleRolesDisplayButton.addEventListener('click', displayOrganizerRolesOverview);
        proceedToGameplayButton.addEventListener('click', showGameplayPhase);

        // Reset game button
        resetGameButton.addEventListener('click', resetGame);

        // Close message box
        closeMessageBox.addEventListener('click', hideMessageBox);

        // Initial load
        window.onload = function () {
            loadGameData(); // Load data first
        };
    </script>
</body>
</html>

